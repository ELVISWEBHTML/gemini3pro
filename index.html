<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini CodeGen</title>
    <!-- Tailwind with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
      // Polyfill process for libraries that might expect it
      window.process = { env: { NODE_ENV: 'production' } };
      
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              gray: {
                850: '#1f2937',
                900: '#111827',
                950: '#030712',
              }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          },
        },
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #111827; }
      ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
      body { margin: 0; background-color: #030712; color: #e5e7eb; }
    </style>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.0.0",
          "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.460.0",
          "@google/genai": "https://esm.sh/@google/genai@1.33.0",
          "react-markdown": "https://esm.sh/react-markdown@10.0.0"
        }
      }
    </script>
  </head>
  <body class="bg-gray-950 text-gray-200 antialiased h-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>
    
    <!-- Error Handler -->
    <script>
      // Global error handler
      window.onerror = function(message, source, lineno, colno, error) {
        const root = document.getElementById('root');
        if (root) {
            root.innerHTML = '<div style="color: #ef4444; padding: 20px; font-family: monospace; background: #1a1a1a; height: 100vh; overflow: auto;">' + 
                '<h1 style="font-size: 24px; margin-bottom: 10px;">Application Error</h1>' + 
                '<p style="font-size: 16px; margin-bottom: 20px;">' + message + '</p>' + 
                '<pre style="background: #000; padding: 10px; border-radius: 4px;">' + (error ? error.stack : 'No stack trace') + '</pre>' + 
                '</div>';
        }
        console.error("Global Error:", message, error);
      };

      window.addEventListener('unhandledrejection', function(event) {
        const root = document.getElementById('root');
        if (root) {
             root.innerHTML = '<div style="color: #ef4444; padding: 20px; font-family: monospace; background: #1a1a1a; height: 100vh; overflow: auto;">' + 
                '<h1 style="font-size: 24px; margin-bottom: 10px;">Unhandled Promise Rejection</h1>' + 
                '<p style="font-size: 16px; margin-bottom: 20px;">' + event.reason + '</p>' + 
                '</div>';
        }
        console.error("Unhandled Rejection:", event.reason);
      });
    </script>

    <script type="text/babel" data-presets="react" data-type="module">
      import React, { useState, useRef, useEffect, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Send, Zap, Trash2, Github, Download, Check, Code, Eye, User, Bot, Sparkles, Key, X, Cpu } from 'lucide-react';
      import { GoogleGenAI } from "@google/genai";
      import ReactMarkdown from 'react-markdown';

      // --- Constants & Config ---
      const SYSTEM_INSTRUCTION = `You are an elite Senior Full-Stack Engineer and Creative Coder. 
Your task is to generate single-file, production-ready HTML applications based on user requests.

Rules:
1.  **Single File:** The output must be a single 'index.html' file.
2.  **Embedded Resources:** CSS must be inside <style> tags. JavaScript must be inside <script> tags.
3.  **External Libraries:** Use reliable CDNs (cdnjs, unpkg) for libraries like React, Vue, Three.js, GSAP, Tailwind CSS, FontAwesome, etc. 
4.  **Tailwind:** If styling is needed, prefer using Tailwind CSS via CDN.
5.  **Quality:** The code must be clean, commented, and visually stunning.
6.  **Output Format:** 
    - Briefly explain the approach (1-2 sentences).
    - Provide the code inside a markdown code block tagged with 'html'.
    - Ensure the code block is complete. Do not use placeholders like "<!-- rest of code -->".
    - Do not assume the user has a build step. It must run directly in a browser.

Thinking Process:
- You have a high thinking budget. Use it to plan the architecture, select the best libraries, and ensure the UI/UX is top-tier before generating the code.`;

      // --- API Service ---
      const getAiClient = () => {
         let key = localStorage.getItem("GEMINI_API_KEY");
         if (!key) {
             return null;
         }
         return new GoogleGenAI({ apiKey: key });
      }

      async function* streamGeminiResponse(promptText, history, modelName = 'gemini-2.5-flash') {
        try {
          const ai = getAiClient();
          if (!ai) throw new Error("API Key not set. Please click the Key icon to configure.");
          
          const chat = ai.chats.create({
            model: modelName,
            config: {
                systemInstruction: SYSTEM_INSTRUCTION,
                temperature: 0.7,
            },
            history: history,
          });
          const result = await chat.sendMessageStream({ message: promptText });
          for await (const chunk of result) {
            if (chunk.text) yield chunk.text;
          }
        } catch (error) {
          console.error(error);
          let msg = error.message || "Unknown error";
          if (msg.includes("429") || msg.includes("Quota")) {
              msg = `**Quota Exceeded:** The model '${modelName}' is busy. Try switching to **gemini-2.5-flash** in Settings.`;
          }
          yield "\n\n**Error:** " + msg;
        }
      }

      // --- Components ---
      const TypewriterText = ({ content }) => {
        return (
          <div className="prose prose-invert prose-slate max-w-none text-gray-300">
            <ReactMarkdown components={{
              code({ className, children, ...props }) {
                const match = /language-(\w+)/.exec(className || '')
                return !match ? (
                  <code className="bg-gray-800 text-indigo-300 px-1 py-0.5 rounded font-mono text-sm" {...props}>{children}</code>
                ) : null;
              }
            }}>{content}</ReactMarkdown>
          </div>
        );
      };

      const CodeViewer = ({ code, language, filename = 'index.html' }) => {
        const [copied, setCopied] = useState(false);
        const [activeTab, setActiveTab] = useState('code');
        const handleDownload = () => {
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        };
        
        return (
            <div className="mt-4 rounded-lg overflow-hidden border border-gray-700 bg-gray-900 shadow-2xl">
              <div className="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700">
                 <div className="flex space-x-2">
                    <button onClick={() => setActiveTab('code')} className={`flex items-center space-x-2 px-3 py-1 rounded-md text-sm transition-colors ${activeTab === 'code' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white'}`}>
                        <Code size={14} /><span>Code</span>
                    </button>
                    <button onClick={() => setActiveTab('preview')} className={`flex items-center space-x-2 px-3 py-1 rounded-md text-sm transition-colors ${activeTab === 'preview' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white'}`}>
                        <Eye size={14} /><span>Preview</span>
                    </button>
                 </div>
                 <div className="flex items-center space-x-3">
                    <span className="text-xs text-gray-500 font-mono uppercase">{language}</span>
                    <button onClick={handleDownload} className="flex items-center space-x-1 text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded transition-colors">
                        {copied ? <Check size={14} className="text-green-400" /> : <Download size={14} />}
                        <span>{copied ? 'Downloaded' : 'Download File'}</span>
                    </button>
                 </div>
              </div>
              <div className="relative">
                {activeTab === 'code' ? (
                     <pre className="p-4 overflow-x-auto text-sm font-mono text-gray-300 leading-relaxed h-96 overflow-y-auto custom-scrollbar"><code>{code}</code></pre>
                ) : (
                    <div className="h-96 w-full bg-white">
                        <iframe srcDoc={code} className="w-full h-full border-0" sandbox="allow-scripts allow-modals" />
                    </div>
                )}
              </div>
            </div>
        );
      };

      const ChatMessage = ({ message }) => {
        const isBot = message.role === 'model';
        const parsedContent = useMemo(() => {
            const codeBlockRegex = /\`\`\`(\w+)?\n([\s\S]*?)\`\`\`/g; 
            const parts = [];
            let lastIndex = 0;
            let match;
            while ((match = codeBlockRegex.exec(message.content)) !== null) {
              if (match.index > lastIndex) parts.push({ type: 'text', content: message.content.substring(lastIndex, match.index) });
              parts.push({ type: 'code', language: match[1] || 'text', content: match[2] });
              lastIndex = codeBlockRegex.lastIndex;
            }
            if (lastIndex < message.content.length) parts.push({ type: 'text', content: message.content.substring(lastIndex) });
            return parts;
        }, [message.content]);

        return (
            <div className={`flex w-full mb-8 ${isBot ? 'justify-start' : 'justify-end'}`}>
                <div className={`flex max-w-4xl w-full ${isBot ? 'flex-row' : 'flex-row-reverse'} gap-4`}>
                    <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${isBot ? 'bg-indigo-600' : 'bg-gray-700'}`}>
                        {isBot ? <Bot size={20} className="text-white" /> : <User size={20} className="text-gray-300" />}
                    </div>
                    <div className={`flex-1 min-w-0 ${isBot ? '' : 'text-right'}`}>
                         <div className="flex items-center gap-2 mb-1">
                            <span className={`font-semibold text-sm ${isBot ? 'text-indigo-400' : 'text-gray-400'}`}>{isBot ? 'Gemini 3 Pro' : 'You'}</span>
                            {isBot && message.isStreaming && <span className="flex items-center text-xs text-indigo-500 animate-pulse"><Sparkles size={12} className="mr-1" />Generating...</span>}
                        </div>
                        <div className={`text-base leading-7 ${isBot ? 'text-gray-300' : 'text-gray-100 bg-gray-800 p-4 rounded-2xl rounded-tr-none inline-block text-left'}`}>
                            {parsedContent.length === 0 && <span className="animate-pulse">Thinking...</span>}
                            {parsedContent.map((part, index) => part.type === 'code' ? <CodeViewer key={index} code={part.content} language={part.language} /> : (isBot ? <TypewriterText key={index} content={part.content} /> : <div key={index} className="whitespace-pre-wrap">{part.content}</div>))}
                        </div>
                    </div>
                </div>
            </div>
        );
      };

      const App = () => {
        const [input, setInput] = useState('');
        const [messages, setMessages] = useState([]);
        const [isStreaming, setIsStreaming] = useState(false);
        const [showSettings, setShowSettings] = useState(false);
        const [apiKey, setApiKey] = useState('');
        // Default to Flash
        const [model, setModel] = useState('gemini-2.5-flash');

        const messagesEndRef = useRef(null);
        const textareaRef = useRef(null);

        useEffect(() => {
          const storedKey = localStorage.getItem("GEMINI_API_KEY");
          if (storedKey) setApiKey(storedKey);
          // Removed intrusive popup check

          const storedModel = localStorage.getItem("GEMINI_MODEL");
          if (storedModel) setModel(storedModel);
        }, []);

        const saveApiKey = (key) => {
          setApiKey(key);
          if (key.trim()) localStorage.setItem("GEMINI_API_KEY", key.trim());
          else localStorage.removeItem("GEMINI_API_KEY");
        };

        const saveModel = (newModel) => {
            setModel(newModel);
            localStorage.setItem("GEMINI_MODEL", newModel);
        };

        useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);
        useEffect(() => { if (textareaRef.current) { textareaRef.current.style.height = 'auto'; textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px'; } }, [input]);

        const handleSend = async () => {
            if (!input.trim() || isStreaming) return;
            const userMessage = { id: Date.now().toString(), role: 'user', content: input, timestamp: Date.now() };
            setMessages(p => [...p, userMessage]);
            setInput('');
            setIsStreaming(true);
            const botMessageId = (Date.now() + 1).toString();
            setMessages(p => [...p, { id: botMessageId, role: 'model', content: '', isStreaming: true, timestamp: Date.now() }]);

            try {
                const history = messages.map(m => ({ role: m.role, parts: [{ text: m.content }] }));
                const stream = streamGeminiResponse(userMessage.content, history, model);
                let fullContent = '';
                for await (const chunk of stream) {
                    fullContent += chunk;
                    setMessages(p => p.map(m => m.id === botMessageId ? { ...m, content: fullContent } : m));
                }
                setMessages(p => p.map(m => m.id === botMessageId ? { ...m, isStreaming: false } : m));
            } catch (error) { console.error(error); } finally { setIsStreaming(false); }
        };

        const downloadThisProject = () => {
             alert("You are already using the downloaded version!");
        };

        return (
            <div className="flex flex-col h-screen bg-gray-950 text-gray-100 relative">
                {/* Settings Modal */}
                {showSettings && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
                        <button onClick={() => setShowSettings(false)} className="absolute right-4 top-4 text-gray-400 hover:text-white"><X size={20} /></button>
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Key className="text-indigo-500" />Settings</h2>
                        <p className="text-gray-400 text-sm mb-6">Configure your API Key and Model. Data is saved locally in your browser.</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Gemini API Key</label>
                                <input type="password" value={apiKey} onChange={(e) => saveApiKey(e.target.value)} placeholder="Only needed if downloaded..." className="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" />
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase mb-1 flex items-center gap-1">
                                    <Cpu size={12} /> Model
                                </label>
                                <select value={model} onChange={(e) => saveModel(e.target.value)} className="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-sans text-sm appearance-none">
                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (Recommended)</option>
                                    <option value="gemini-3-pro-preview">Gemini 3 Pro (High Quality)</option>
                                </select>
                            </div>

                            <div className="pt-2">
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="inline-flex items-center text-indigo-400 hover:text-indigo-300 text-sm font-medium transition-colors">Get a free API key here &rarr;</a>
                            </div>
                        </div>
                        <div className="mt-8 flex justify-end">
                            <button onClick={() => setShowSettings(false)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/20">Close</button>
                        </div>
                    </div>
                    </div>
                )}

                <header className="flex items-center justify-between px-6 py-4 bg-gray-900 border-b border-gray-800 shadow-md z-10">
                    <div className="flex items-center gap-3">
                         <div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-lg shadow-lg shadow-indigo-500/20"><Zap className="text-white" size={24} /></div>
                         <div><h1 className="font-bold text-xl tracking-tight text-white">Gemini CodeGen</h1><p className="text-xs text-gray-400">Powered by Google Gemini</p></div>
                    </div>
                    <div className="flex items-center gap-3">
                        {messages.length > 0 && <button onClick={() => setMessages([])} className="p-2 text-gray-400 hover:text-red-400 transition-colors"><Trash2 size={20} /></button>}
                        <button onClick={downloadThisProject} className="p-2 text-gray-400 hover:text-white transition-colors" title="Download Project HTML"><Download size={20} /></button>
                        <button onClick={() => setShowSettings(true)} className={`p-2 transition-colors ${apiKey ? 'text-indigo-400 hover:text-indigo-300' : 'text-gray-400 hover:text-white'}`} title="Settings"><Key size={20} /></button>
                        <a href="#" className="p-2 text-gray-400 hover:text-white transition-colors"><Github size={20} /></a>
                    </div>
                </header>
                <main className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                    <div className="max-w-5xl mx-auto">
                        {messages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-center text-gray-500">
                                <div className="mb-6 p-6 bg-gray-900 rounded-full bg-opacity-50 border border-gray-800"><Zap size={48} className="text-indigo-500 opacity-80" /></div>
                                <h2 className="text-2xl font-semibold text-white mb-2">What shall we build today?</h2>
                                <p className="max-w-md text-gray-400">I can code entire HTML/JS apps for you. Just describe it.</p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-8 max-w-lg w-full">
                                    {['Create a 3D solar system with Three.js', 'Make a modern Todo app', 'Design a portfolio', 'Code a particle simulation'].map(s => (
                                        <button key={s} onClick={() => setInput(s)} className="text-sm p-3 bg-gray-900 hover:bg-gray-800 border border-gray-800 rounded-lg transition-all text-left">{s}</button>
                                    ))}
                                </div>
                            </div>
                        ) : messages.map(msg => <ChatMessage key={msg.id} message={msg} />)}
                        <div ref={messagesEndRef} />
                    </div>
                </main>
                <footer className="p-4 bg-gray-900 border-t border-gray-800">
                    <div className="max-w-4xl mx-auto relative">
                        <textarea ref={textareaRef} value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => {if(e.key === 'Enter' && !e.shiftKey) {e.preventDefault(); handleSend();}}} placeholder={isStreaming ? "Thinking..." : "Describe the app..."} disabled={isStreaming} rows={1} className="w-full bg-gray-950 text-gray-100 border border-gray-700 rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none max-h-48 shadow-inner font-sans text-base disabled:opacity-50" />
                        <button onClick={handleSend} disabled={!input.trim() || isStreaming} className="absolute right-2 bottom-2.5 p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-all disabled:opacity-0 disabled:scale-75 shadow-lg"><Send size={18} /></button>
                    </div>
                    <div className="text-center mt-2 text-xs text-gray-500">Running on {model}</div>
                </footer>
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>